<!DOCTYPE html>
<html lang="ko">
<head>
    {% include '/comm/adheader.html' %}
<body id="page-top">
<!-- Page Wrapper -->
<div id="wrapper">
    {% include '/comm/sidebar.html' %}
    <!-- Content Wrapper -->
    <div id="content-wrapper" class="d-flex flex-column">
        <!-- Main Content -->
        <div id="content">
            {% include '/comm/adtopbar.html' %}
            <!-- Begin Page Content -->
            <div class="container-fluid">
                <!-- Page Heading -->
                <ul class="nav nav-pills">
                    {% set slots = [(1,3),(2,6),(3,9),(4,12),(5,15)] %}
                    {% for num, threshold in slots %}
                    {% if license >= threshold %}
                    <li class="nav-item">
                        <a class="nav-link {% if slot == num %}active{% endif %}"
                           href="/mymtpondstat/{{ user_No }}/{{ setkey }}/{{ num }}">SLOT {{ '%02d' % num }}</a>
                    </li>
                    {% endif %}
                    {% endfor %}
                </ul>
                <div class="row">
                    <div class="col-lg-4">
                        <div class="card ">
                            <div class="card-header py-3">
                                <h6 class="m-0 font-weight-bold text-primary">설정내용 1 </h6>
                            </div>
                            <div class="card-body">
                                <div class="table-responsive">
                                    <table class="table table-bordered" id="dataTable1" width="100%" cellspacing="0">
                                        <tbody>
                                        <tr>
                                            <td style="text-align: center">설정 코인</td>
                                            <td style="text-align: center">
                                                <select id="selcoin1" name="selcoin1" class="form-control"
                                                        data-api-endpoint="http://ywydpapa.iptime.org:8000/api/top30trend"></select>
                                            </td>
                                        </tr>
                                        <tr>
                                            <td style="text-align: center">시작금액/한도금액</td>
                                            <td id="initamount" style="text-align: right">{{ "{:,}".format(setups[0][3]) }}원 / {{ "{:,}".format(setups[0][5]) }}원
                                            </td>
                                        </tr>
                                        <tr>
                                            <td style="text-align: center">현재가/(매수액/매도액)</td>
                                            <td>
                                                <div style="display: flex; width: 100%; text-align: right;">
                                                    <span id="curtrade1-price" style="flex: 1;"></span>
                                                    <span id="curtrade1-bid" style="flex: 1; border-left: 1px solid #eee; border-right: 1px solid #eee; color: green;"></span>
                                                    <span id="curtrade1-ask" style="flex: 1; color: blue;"></span>
                                                </div>
                                            </td>
                                        </tr>
                                        <tr style="display: none">
                                            <td style="text-align: center">추가매수설정</td>
                                            <td style="text-align: right"></td>
                                        </tr>
                                        <tr>
                                            <td style="text-align: center">거래설정</td>
                                            <td style="text-align: right">
                                                <div class="d-flex" style="gap: 1.5rem;">
                                                    <div class="custom-control custom-switch flex-fill text-center">
                                                        <input class="custom-control-input" type="checkbox"
                                                               id="autochg1" name="autochg1" checked/>
                                                        <label class="custom-control-label" for="autochg1">자동전환</label>
                                                    </div>
                                                </div>
                                            </td>
                                        </tr>
                                        <tr>
                                            <td style="text-align: center">손절설정</td>
                                            <td class="align-items-center">
                                                <div class="d-flex align-items-center justify-content-center"
                                                     style="gap: 12px;">
                                                    <div class="custom-control custom-switch">
                                                        <input class="custom-control-input" type="checkbox" id="chklc1"
                                                               name="chklc1" {% if setups[0][12]== 'on' %}checked{%
                                                        endif %} />
                                                        <label class="custom-control-label" for="chklc1"></label>
                                                    </div>
                                                    <input class="form-control-sm"
                                                           style="text-align: right; border: #717384" type="number"
                                                           name="lcrate1" id="lcrate1" value="{{ setups[0][9] }}"
                                                           max="-1.5" min="-10" step="0.1"/>
                                                    <label class="form-control-sm" for="lcrate1"
                                                           style="margin-bottom: 0;">%</label>
                                                </div>
                                            </td>
                                        </tr>
                                        <tr>
                                            <td style="text-align: center">동작상태</td>
                                            <td style="text-align: center">
                                                <div class="custom-control custom-switch">
                                                    <h4>
                                                        <input style="zoom: 150%;" type="checkbox"
                                                               class="custom-control-input" id="chk1" name="chk1" {% if
                                                               setups[0][11]== 'Y' %}checked{% endif %} />
                                                        <label class="custom-control-label" for="chk1">on/off</label>
                                                    </h4>
                                                </div>
                                            </td>
                                        </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-4">
                        <div class="card ">
                            <div class="card-header py-3">
                                <h6 class="m-0 font-weight-bold text-primary">설정내용 2 </h6>
                            </div>
                            <div class="card-body">
                                <div class="table-responsive">
                                    <table class="table table-bordered" id="dataTable2" width="100%" cellspacing="0">
                                        <tbody>
                                        <tr>
                                            <td style="text-align: center">설정 코인</td>
                                            <td style="text-align: center">
                                                <select id="selcoin2" name="selcoin2" class="form-control"
                                                        data-api-endpoint="http://ywydpapa.iptime.org:8000/api/top30trend"></select>
                                            </td>
                                        </tr>
                                        <tr>
                                            <td style="text-align: center">시작금액/한도금액</td>
                                            <td id="initamount2" style="text-align: right">{{ "{:,}".format(setups[1][3]) }}원 / {{ "{:,}".format(setups[1][5]) }}원
                                            </td>
                                        </tr>
                                        <tr>
                                            <td style="text-align: center">현재가/(매수액/매도액)</td>
                                            <td>
                                                <div style="display: flex; width: 100%; text-align: right;">
                                                    <span id="curtrade2-price" style="flex: 1;"></span>
                                                    <span id="curtrade2-bid" style="flex: 1; border-left: 1px solid #eee; border-right: 1px solid #eee; color: green;"></span>
                                                    <span id="curtrade2-ask" style="flex: 1; color: blue;"></span>
                                                </div>
                                            </td>
                                        </tr>
                                        <tr style="display: none">
                                            <td style="text-align: center">추가매수설정</td>
                                            <td style="text-align: right"></td>
                                        </tr>
                                        <tr>
                                            <td style="text-align: center">거래설정</td>
                                            <td style="text-align: right">
                                                <div class="d-flex" style="gap: 1.5rem;">
                                                    <div class="custom-control custom-switch flex-fill text-center">
                                                        <input class="custom-control-input" type="checkbox"
                                                               id="autochg2" name="autochg2" checked/>
                                                        <label class="custom-control-label" for="autochg2">자동전환</label>
                                                    </div>
                                                </div>
                                            </td>
                                        </tr>
                                        <tr>
                                            <td style="text-align: center">손절설정</td>
                                            <td class="align-items-center">
                                                <div class="d-flex align-items-center justify-content-center"
                                                     style="gap: 12px;">
                                                    <div class="custom-control custom-switch">
                                                        <input class="custom-control-input" type="checkbox" id="chklc2"
                                                               name="chklc1" {% if setups[1][12]== 'on' %}checked{%
                                                        endif %} />
                                                        <label class="custom-control-label" for="chklc2"></label>
                                                    </div>
                                                    <input class="form-control-sm"
                                                           style="text-align: right; border: #717384" type="number"
                                                           name="lcrate2" id="lcrate2" value="{{ setups[1][9] }}"
                                                           max="-1.5" min="-10" step="0.1"/>
                                                    <label class="form-control-sm" for="lcrate1"
                                                           style="margin-bottom: 0;">%</label>
                                                </div>
                                            </td>
                                        </tr>
                                        <tr>
                                            <td style="text-align: center">동작상태</td>
                                            <td style="text-align: center">
                                                <div class="custom-control custom-switch">
                                                    <h4>
                                                        <input style="zoom: 150%;" type="checkbox"
                                                               class="custom-control-input" id="chk2" name="chk2" {% if
                                                               setups[1][11]== 'Y' %}checked{% endif %} />
                                                        <label class="custom-control-label" for="chk2">on/off</label>
                                                    </h4>
                                                </div>
                                            </td>
                                        </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-4">
                        <div class="card ">
                            <div class="card-header py-3">
                                <h6 class="m-0 font-weight-bold text-primary">설정내용 3 </h6>
                            </div>
                            <div class="card-body">
                                <div class="table-responsive">
                                    <table class="table table-bordered" id="dataTable3" width="100%" cellspacing="0">
                                        <tbody>
                                        <tr>
                                            <td style="text-align: center">설정 코인</td>
                                            <td style="text-align: center">
                                                <select id="selcoin3" name="selcoin3" class="form-control"
                                                        data-api-endpoint="http://ywydpapa.iptime.org:8000/api/top30trend"></select>
                                            </td>
                                        </tr>
                                        <tr>
                                            <td style="text-align: center">시작금액/한도금액</td>
                                            <td id="initamount3" style="text-align: right">{{ "{:,}".format(setups[2][3]) }}원 / {{ "{:,}".format(setups[2][5]) }}원
                                            </td>
                                        </tr>
                                        <tr>
                                            <td style="text-align: center">현재가/(매수액/매도액)</td>
                                            <td>
                                                <div style="display: flex; width: 100%; text-align: right;">
                                                    <span id="curtrade3-price" style="flex: 1;"></span>
                                                    <span id="curtrade3-bid" style="flex: 1; border-left: 1px solid #eee; border-right: 1px solid #eee; color: green;"></span>
                                                    <span id="curtrade3-ask" style="flex: 1; color: blue;"></span>
                                                </div>
                                            </td>
                                        </tr>
                                        <tr style="display: none">
                                            <td style="text-align: center">추가매수설정</td>
                                            <td style="text-align: right"></td>
                                        </tr>
                                        <tr>
                                            <td style="text-align: center">거래설정</td>
                                            <td style="text-align: right">
                                                <div class="d-flex" style="gap: 1.5rem;">
                                                    <div class="custom-control custom-switch flex-fill text-center">
                                                        <input class="custom-control-input" type="checkbox"
                                                               id="autochg3" name="autochg3" checked/>
                                                        <label class="custom-control-label" for="autochg3">자동전환</label>
                                                    </div>
                                                </div>
                                            </td>
                                        </tr>
                                        <tr>
                                            <td style="text-align: center">손절설정</td>
                                            <td class="align-items-center">
                                                <div class="d-flex align-items-center justify-content-center"
                                                     style="gap: 12px;">
                                                    <div class="custom-control custom-switch">
                                                        <input class="custom-control-input" type="checkbox" id="chklc3"
                                                               name="chklc1" {% if setups[2][12]== 'on' %}checked{%
                                                        endif %} />
                                                        <label class="custom-control-label" for="chklc3"></label>
                                                    </div>
                                                    <input class="form-control-sm"
                                                           style="text-align: right; border: #717384" type="number"
                                                           name="lcrate1" id="lcrate3" value="{{ setups[2][9] }}"
                                                           max="-1.5" min="-10" step="0.1"/>
                                                    <label class="form-control-sm" for="lcrate3"
                                                           style="margin-bottom: 0;">%</label>
                                                </div>
                                            </td>
                                        </tr>
                                        <tr>
                                            <td style="text-align: center">동작상태</td>
                                            <td style="text-align: center">
                                                <div class="custom-control custom-switch">
                                                    <h4>
                                                        <input style="zoom: 150%;" type="checkbox"
                                                               class="custom-control-input" id="chk3" name="chk3" {% if
                                                               setups[2][11]== 'Y' %}checked{% endif %} />
                                                        <label class="custom-control-label" for="chk3">on/off</label>
                                                    </h4>
                                                </div>
                                            </td>
                                        </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- ... existing code ... -->
                    <div class="col-lg-4">
                        <div class="card shadow mb-4">
                            <div class="card-header py-3">
                                <h6 class="m-0 font-weight-bold text-primary">코인트렌드</h6>
                            </div>
                            <div class="card-body">
                                <div class="card-body" style="height: 90%; display: flex; align-items: center; justify-content: center;">
                                    <div class="chart-area" style="width: 90%; height: 90%;">
                                        <canvas id="trendChart1" style="width:100%; height:100%;"></canvas>
                                    </div>
                                </div>
                            </div>
                            <div class="card-footer">
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-4">
                        <div class="card shadow mb-4">
                            <div class="card-header py-3">
                                <h6 class="m-0 font-weight-bold text-primary">코인트렌드</h6>
                            </div>
                            <div class="card-body">
                                <div class="card-body" style="height: 90%; display: flex; align-items: center; justify-content: center;">
                                    <div class="chart-area" style="width: 90%; height: 90%;">
                                        <canvas id="trendChart2" style="width:100%; height:100%;"></canvas>
                                    </div>
                                </div>                            </div>
                            <div class="card-footer">
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-4">
                        <div class="card shadow mb-4">
                            <div class="card-header py-3">
                                <h6 class="m-0 font-weight-bold text-primary">코인트렌드</h6>
                            </div>
                            <div class="card-body">
                                <div class="card-body" style="height: 90%; display: flex; align-items: center; justify-content: center;">
                                    <div class="chart-area" style="width: 90%; height: 90%;">
                                        <canvas id="trendChart3" style="width:100%; height:100%;"></canvas>
                                    </div>
                                </div>                            </div>
                            <div class="card-footer">
                            </div>
                        </div>
                    </div>
                </div>
                <!-- DataTales Example -->
                <div class="card shadow mb-4">
                    <div class="card-header py-3">
                        <h6 class="m-0 font-weight-bold text-primary">거래현황</h6>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                        </div>
                    </div>
                </div>
            </div>
            <!-- /.container-fluid -->
        </div>
        <!-- End of Main Content -->
        <!-- Footer -->
        <footer class="sticky-footer bg-white">
            <div class="container my-auto">
                <div class="copyright text-center my-auto">
                    <span>Copyright &copy; Coredjk 2025</span>
                </div>
            </div>
        </footer>
        <!-- End of Footer -->
    </div>
    <!-- End of Content Wrapper -->
</div>
<!-- End of Page Wrapper -->
<!-- Scroll to Top Button-->
<a class="scroll-to-top rounded" href="#page-top">
    <i class="fas fa-angle-up"></i>
</a>
<!-- Bootstrap core JavaScript-->
{% include '/comm/adscript.html' %}
{% include './comm/adscriptchart.html' %}

<script>
const selectIds = ['selcoin1', 'selcoin2', 'selcoin3'];
let coinList = []; // API에서 받아올 전체 코인 목록
let selectedCoins = []; // 현재 선택된 3개 코인명

// 차트 객체 저장용
const charts = {};

// 체결 및 가격 데이터 저장용
const recentTrades = {};
const priceHistory = {};
const currentPrices = {};

// 콤마 찍기 함수
function numberWithCommas(x) {
    if (x == null) return '';
    return x.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
}

// fillSelects 함수: 셀렉트 박스 중복 방지 및 옵션 채우기
function fillSelects(selectedValues = {}) {
    selectIds.forEach(id => {
        const sel = document.getElementById(id);
        if (!sel) return;
        sel.innerHTML = '';
        coinList.forEach(coin => {
            const opt = document.createElement('option');
            opt.value = coin;
            opt.textContent = coin;
            // 다른 셀렉트에서 이미 선택된 코인은 비활성화
            if (Object.values(selectedValues).includes(coin) && selectedValues[id] !== coin) {
                opt.disabled = true;
            }
            sel.appendChild(opt);
        });
        // 선택값이 있으면 선택, 없으면 첫 번째 활성화된 옵션 선택
        if (selectedValues[id]) {
            sel.value = selectedValues[id];
        } else {
            // disabled 아닌 첫 번째 옵션 선택
            for (const option of sel.options) {
                if (!option.disabled) {
                    sel.value = option.value;
                    break;
                }
            }
        }
    });
}

// 선택된 코인 배열 반환
function getSelectedCoins() {
    return selectIds.map(id => {
        const sel = document.getElementById(id);
        return sel ? sel.value : '';
    });
}

// 차트 생성 함수
function createTrendChart(canvasId, color) {
    const ctx = document.getElementById(canvasId).getContext('2d');
    return new Chart(ctx, {
        type: 'line',
        data: {
            labels: Array(20).fill(''),
            datasets: [{
                label: '현재가',
                data: [],
                borderColor: color,
                backgroundColor: color.replace('1)', '0.1)'),
                pointRadius: 0,
                borderWidth: 2,
                tension: 0.2
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { display: false } },
            scales: {
                x: { display: false },
                y: { display: true }
            }
        }
    });
}

// 트렌드 차트 갱신 함수
function updateTrendChart(idx, price) {
    const selected = getSelectedCoins();
    const market = selected[idx];
    if (!priceHistory[market]) priceHistory[market] = [];
    priceHistory[market].push(price);
    if (priceHistory[market].length > 20) {
        priceHistory[market].shift();
    }
    const chart = charts[market];
    if (chart) {
        chart.data.datasets[0].data = priceHistory[market];
        chart.update();
    }
}

// 웹소켓 객체
let ws = null;

// 웹소켓 연결 및 메시지 처리
function connectWebSocket() {
    // 기존 연결 종료
    if (ws) ws.close();

    selectedCoins = getSelectedCoins();
    const protocol = location.protocol === "https:" ? "wss" : "ws";
    ws = new WebSocket(`${protocol}://${location.host}/ws/trade?coins=${selectedCoins.join(",")}`);

    // 데이터 구조 초기화
    selectedCoins.forEach((coin, idx) => {
        recentTrades[coin] = [];
        priceHistory[coin] = [];
        currentPrices[coin] = null;
        // 차트 초기화
        const canvasId = `trendChart${idx+1}`;
        const color = ['rgba(255,99,132,1)','rgba(54,162,235,1)','rgba(255,206,86,1)'][idx];
        charts[coin] = createTrendChart(canvasId, color);

        // UI 초기화
        document.getElementById(`curtrade${idx+1}-price`).innerText = '-';
        document.getElementById(`curtrade${idx+1}-bid`).innerText = '-';
        document.getElementById(`curtrade${idx+1}-ask`).innerText = '-';
    });

    ws.onmessage = function(event) {
        const data = JSON.parse(event.data);
        // 데이터 예시: { market: "KRW-BTC", trade_price: 12345, trade_volume: 1.23, ask_bid: "BID" }
        const market = data.market || data.coin;
        if (!market || !selectedCoins.includes(market)) return;

        // 체결 데이터 관리
        if (!recentTrades[market]) recentTrades[market] = [];
        recentTrades[market].push(data);
        if (recentTrades[market].length > 20) {
            recentTrades[market].shift();
        }

        // 매수/매도 합계 계산
        let bidSumKRW = 0;
        let askSumKRW = 0;
        recentTrades[market].forEach(trade => {
            if (trade.ask_bid === "BID") {
                bidSumKRW += trade.trade_volume * trade.trade_price;
            } else if (trade.ask_bid === "ASK") {
                askSumKRW += trade.trade_volume * trade.trade_price;
            }
        });

        // 인덱스 찾기
        const idx = selectedCoins.indexOf(market);

        // UI에 값 표시
        document.getElementById(`curtrade${idx+1}-price`).innerText = numberWithCommas(data.trade_price);
        document.getElementById(`curtrade${idx+1}-bid`).innerText = numberWithCommas(bidSumKRW.toFixed(0));
        document.getElementById(`curtrade${idx+1}-ask`).innerText = numberWithCommas(askSumKRW.toFixed(0));

        // 가격 히스토리 저장 및 차트 갱신
        if (!priceHistory[market]) priceHistory[market] = [];
        priceHistory[market].push(data.trade_price);
        if (priceHistory[market].length > 20) {
            priceHistory[market].shift();
        }
        const chart = charts[market];
        if (chart) {
            chart.data.datasets[0].data = priceHistory[market];
            chart.update();
        }

        // 추가적으로 차익 등 갱신 함수가 있다면 호출
        if (typeof updateCudiff === "function") updateCudiff();
    };

    ws.onerror = function(e) {
        console.error("WebSocket error:", e);
    };
}

// 셀렉트 변경 이벤트 핸들러
function onSelectChange() {
    // fillSelects로 중복 방지 옵션 처리
    const selectedValues = {};
    selectIds.forEach(id => {
        const sel = document.getElementById(id);
        if (!sel) return;
        selectedValues[id] = sel.value;
    });
    fillSelects(selectedValues);

    // 코인 선택이 바뀌면 웹소켓 재연결 및 차트/데이터 초기화
    connectWebSocket();
}

document.addEventListener('DOMContentLoaded', function() {
    fetch('http://ywydpapa.iptime.org:8000/api/top30coins')
        .then(response => response.json())
        .then(data => {
            if (data && data.markets && Array.isArray(data.markets)) {
                coinList = data.markets;
                // 최초 선택값: 앞에서부터 3개
                const initialValues = {
                    selcoin1: coinList[0] || '',
                    selcoin2: coinList[1] || '',
                    selcoin3: coinList[2] || ''
                };
                fillSelects(initialValues);
                selectIds.forEach(id => {
                    const sel = document.getElementById(id);
                    if (!sel) return;
                    sel.addEventListener('change', onSelectChange);
                });
                // 최초 연결
                connectWebSocket();
            }
        });
});
</script>


</body>
</html>


