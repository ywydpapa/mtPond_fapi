<!DOCTYPE html>
<html lang="en">
<head>
    {% include '/comm/adheader.html' %}
 <style>
    #dataTable tr td {
  height: 44px;
  padding-top: 0;
  padding-bottom: 0;
  vertical-align: middle;
  line-height: 1.2;
}
  .change-up {
    color: #22c55e; /* 초록색 */
    font-size: 1.0em;
  }
  .change-down {
    color: #ef4444; /* 빨간색 */
    font-size: 1.0em;
  }
  .change-even {
    color: #64748b; /* 중립 회색 */
    font-size: 1.0em;
  }
</style>

</head>
<body id="page-top">
<!-- Page Wrapper -->
<div id="wrapper">
    {% include '/comm/sidebar.html' %}
    <!-- Content Wrapper -->
    <div id="content-wrapper" class="d-flex flex-column">
        <!-- Main Content -->
        <div id="content">
            {% include '/comm/adtopbar.html' %}
            <!-- Begin Page Content -->
            <div class="container-fluid">
               <div class="d-flex align-items-center justify-content-between mb-4">
                        <h2 class="mb-0">Upbit 코인 실시간 체결금액 상위 30 모니터링</h2>
                        <div class="d-flex align-items-center">
                        <h5 class="mb-0 mr-2">구매금액</h5>
                        <input type="number" id="buyamt" value="100000" step="10000" style="width: 100px; text-align: right; margin-right: 10px;">
                        </div>
                    </div>
                    <table class="table table-striped table-bordered align-middle text-center" id="trade-table">
                    <thead class="table-light">
                        <tr style="text-align: center;">
                            <th class="text-center">코인명</th>
                            <th class="text-center">체결량</th>
                            <th class="text-center">매수(10)</th>
                            <th class="text-center">매도(10)</th>
                            <th class="text-center">매수(30)</th>
                            <th class="text-center">매도(30)</th>
                            <th class="text-center">매수(120)</th>
                            <th class="text-center">매도(120)</th>
                            <th class="text-center">매수(240)</th>
                            <th class="text-center">매도(240)</th>
                            <th class="text-center">RATE 10</th>
                            <th class="text-center">RATE 30</th>
                            <th class="text-center">RATE 120</th>
                            <th class="text-center">RATE 240</th>
                            <th class="text-center">TREND</th>
                            <th class="text-center">TRADE</th>
                        </tr>
                    </thead>
                    <tbody>
                    </tbody>
                    </table>
            </div>
            <!-- /.container-fluid -->
        </div>
        <!-- End of Main Content -->
        <!-- Footer -->
        <footer class="sticky-footer bg-white">
            <div class="container my-auto">
                <div class="copyright text-center my-auto">
                    <span>Copyright &copy; Coredjk 2025</span>
                </div>
            </div>
        </footer>
        <!-- End of Footer -->
    </div>
    <!-- End of Content Wrapper -->
</div>
<!-- End of Page Wrapper -->
<!-- Scroll to Top Button-->
<a class="scroll-to-top rounded" href="#page-top">
    <i class="fas fa-angle-up"></i>
</a>
<!-- Bootstrap core JavaScript-->

{% include '/comm/adscript.html' %}
<script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>
<script>
$(document).ready(function () {
});

const protocol = location.protocol === "https:" ? "wss" : "ws";
let ws = new WebSocket("ws://ywydpapa.iptime.org:8000/ws/top30trend");

    ws.onopen = function() {
        console.log("WebSocket 연결됨");
    };
    ws.onerror = function(e) {
        console.error("WebSocket 에러", e);
    };
ws.onclose = function() {
    console.log("WebSocket closed");
};

let table = $('#trade-table').DataTable({
    "paging": true,
    "searching": true,
    "ordering": true,
    "info": false,
    "pageLength": 30,
    "order": [[2, "desc"]],
    "columnDefs": [
        {
        "targets": [0],
        "className": "text-center",
        "render": function(data, type, row) {
            if (type === 'display') {
                return `<a href="https://upbit.com/exchange?code=CRIX.UPBIT.${data}" target="_blank">${data}</a>`;
            }
            return data;
        }
        },
        { "targets": [1], "className": "text-center" },
        {
            "targets": [2,4,6,8], // 매수금액
            "render": function (data, type, row) {
                if (type === 'display') {
                    return `<span class="text-success">${parseInt(data).toLocaleString()}</span>`;
                }
                return data;
            },
            "type": "num",
            "className": "text-end"
        },
        {
            "targets": [3,5,7,9], // 매도금액
            "render": function (data, type, row) {
                if (type === 'display') {
                    return `<span class="text-danger">${parseInt(data).toLocaleString()}</span>`;
                }
                return data;
            },
            "type": "num",
            "className": "text-end"
        },
        {
            "targets": [10,11,12,13], // 비율(%)
            "render": function (data, type, row) {
                if (type === 'display') {
                    let color = (parseFloat(data) >= 100) ? 'text-success' : 'text-danger';
                    return `<span class="${color}">${data}%</span>`;
                }
                return data;
            },
            "type": "num",
            "className": "text-end"
        },
        {
    "targets": [14], // TREND 컬럼 인덱스
    "render": function(data, type, row) {
        if (type === 'display') {
            if (!data) return '';
            // 크로스 표시
            let cross = data.type === 'golden' ? '<span class="text-success fw-bold">G</span>' :
                        data.type === 'dead' ? '<span class="text-danger fw-bold">D</span>' : '';
            // 경과 시간 표시
            let min = Math.floor(data.elapsed / 60);
            let sec = Math.floor(data.elapsed % 60);
            let elapsedStr = `${min}:${sec.toString().padStart(2, '0')}`;
            // VWMA 화살표
            let arrows = '';
            if (data.VWMA_3_dir && data.VWMA_3_angle !== undefined) {
                arrows += getArrow(data.VWMA_3_dir, data.VWMA_3_angle);
            }
            if (data.VWMA_20_dir && data.VWMA_20_angle !== undefined) {
                arrows += getArrow(data.VWMA_20_dir, data.VWMA_20_angle);
            }
            return `${cross} <span class="text-muted">${elapsedStr}</span><br> ${arrows}`;
        }
        return data;
    },
    "className": "text-center"
},
        {
    "targets": [15], // TRADE 컬럼 인덱스
    "render": function (data, type, row) {
        if (type === 'display') {
            // row[0]이 market(코인명)이라고 가정 (table.row.add([...])에서 첫번째 값)
            let coinn = row[0];
            // 템플릿 변수는 서버에서 렌더링 시 실제 값으로 치환됨
            return `<button class="btn btn-sm btn-success" onclick="buycoin('{{user_No}}', '{{setkey}}', '${coinn}')">매수</button>`;
        }
        return data;
    },
    "className": "text-center"
}
    ]
});

    let trendData = {}; // aitrendall 결과 저장

    function getArrow(dir, angle) {
    if (dir === "UP") {
        if (angle >= 45) return '<span style="color:green;">(▲▲)</span>';
        else return '<span style="color:green;">(▲)</span>';
    }
    if (dir === "DN") {
        if (angle <= -45) return '<span style="color:red;">(▼▼)</span>';
        else return '<span style="color:red;">(▼)</span>';
    }
    return '';
}

function fetchTrendData() {
    $.get('http://ywydpapa.iptime.org:8000/api/aitrendt30', function(data) {
        trendData = data;
    });
}
fetchTrendData();
setInterval(fetchTrendData, 30000); // 0.5분마다 갱신

    ws.onmessage = function(event) {
    let data = JSON.parse(event.data);
    let coins = data.coins;
    table.clear();
    coins.forEach(row => {
        let trend = trendData[row.market]; // 이 부분 추가
        let trendCell = null;
        if (trend) {
            trendCell = {
                type: trend.latest_cross_type,
                elapsed: trend.elapsed,
                VWMA_3_dir: trend.VWMA_3_dir,
                VWMA_20_dir: trend.VWMA_20_dir,
                VWMA_3_angle: trend.VWMA_3_angle,
                VWMA_20_angle: trend.VWMA_20_angle
            };
        }
        table.row.add([
            row.market,
            row.speed,
            row.bid10,
            row.ask10,
            row.bid30,
            row.ask30,
            row.bid120,
            row.ask120,
            row.bid240,
            row.ask240,
            row.ratio10,
            row.ratio30,
            row.ratio120,
            row.ratio240,
            trendCell,
            null
        ]);
    });
    table.draw(false);
};

function safeParseFloat(val) {
    if (typeof val === "undefined" || val === null) return 0;
    let v = parseFloat(val.toString().replace(/,/g, ''));
    return isNaN(v) ? 0 : v;
}

function numberWithCommas(x) {
    x = x.toString();
    var parts = x.split(".");
    parts[0] = parts[0].replace(/\B(?=(\d{3})+(?!\d))/g, ",");
    return parts.length > 1 ? parts[0] + "." + parts[1] : parts[0];
}

function numberNoneCommas(x) {
    return x.toString().replace(/[\D\s\._\-]+/g, "");
}

function buycoin(uno, skey, coinn) {
    if (confirm("본 코인을 시장가로 매수하시겠습니까?")) {
        let costk = numberNoneCommas($("#buyamt").val());
        coinn = coinn.replace("KRW-", "");
        $.ajax({
            type: "POST",
            url: `/tradebuymarket/${uno}/${skey}/${encodeURIComponent(coinn)}/${costk}`,
            processData: false,
            contentType: false,
            success: (res) => {
                alert("구매 성공");
            },
            error: function (err) {
                alert("매수 요청 실패: " + (err.responseText || ""));
            }
        });
    }
}

</script>
</body>
</html>
